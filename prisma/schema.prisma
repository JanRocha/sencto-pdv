generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                  String      @id @default(cuid())
  fullName            String
  cpf                 String      @unique
  email               String      @unique
  phone               String
  passwordHash        String
  role                String
  active              Boolean     @default(true)
  failedLoginAttempts Int         @default(0)
  lockedUntil         DateTime?
  lastAccessAt        DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  sales               Sale[]
  cashRegisters       CashRegister[]
  cashMovements       CashMovement[]
  logs                AuditLog[]
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
}

model Product {
  id                String      @id @default(cuid())
  name              String
  description       String?
  barcode           String      @unique
  internalCode      String?     @unique
  categoryId        String
  salePrice         Decimal
  promoPrice        Decimal?
  costPrice         Decimal?
  stock             Int
  minStock          Int
  unit              String
  type              String
  ncm               String
  cfop              String
  cstOrCsosn        String
  icmsRate          Decimal
  pisRate           Decimal
  cofinsRate        Decimal
  fiscalOrigin      String?
  active            Boolean     @default(true)
  imageUrl          String?
  internalNotes     String?
  sellByCommand     Boolean     @default(false)
  supplier          String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  category          Category    @relation(fields: [categoryId], references: [id])
  saleItems         SaleItem[]
  visitorItems      VisitItem[]
}

model CashRegister {
  id            String        @id @default(cuid())
  userId        String
  openedAt      DateTime      @default(now())
  closedAt      DateTime?
  initialAmount Decimal
  observations  String?
  status        String        @default("ABERTO")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  user          User          @relation(fields: [userId], references: [id])
  sales         Sale[]
  movements     CashMovement[]
}

model CashMovement {
  id             String        @id @default(cuid())
  cashRegisterId String
  userId         String
  type           String
  amount         Decimal
  reason         String
  createdAt      DateTime      @default(now())
  cashRegister   CashRegister  @relation(fields: [cashRegisterId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
}

model Sale {
  id             String       @id @default(cuid())
  userId         String
  cashRegisterId String
  subtotal       Decimal
  discount       Decimal      @default(0)
  total          Decimal
  paymentMethod  String
  installments   Int?
  customerCpf    String?
  createdAt      DateTime     @default(now())
  user           User         @relation(fields: [userId], references: [id])
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id])
  items          SaleItem[]
}

model SaleItem {
  id        String   @id @default(cuid())
  saleId    String
  productId String
  quantity  Int
  unitPrice Decimal
  total     Decimal
  note      String?
  sale      Sale     @relation(fields: [saleId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
}

model Tutor {
  id          String    @id @default(cuid())
  fullName    String
  cpf         String    @unique
  birthDate   DateTime
  email       String
  phone1      String
  phone2      String?
  address     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  children    Child[]
  visits      Visit[]
}

model Child {
  id             String    @id @default(cuid())
  tutorId        String
  fullName       String
  birthDate      DateTime
  specialDiscount Boolean  @default(false)
  consumeLimit   Decimal?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  tutor          Tutor     @relation(fields: [tutorId], references: [id])
  visits         Visit[]
}

model Visit {
  id             String     @id @default(cuid())
  tutorId         String
  childId         String
  ticketProductId String
  entryAt         DateTime   @default(now())
  expectedExitAt  DateTime
  status          String     @default("ABERTA")
  paymentStatus   String     @default("PENDENTE")
  total           Decimal    @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  tutor           Tutor      @relation(fields: [tutorId], references: [id])
  child           Child      @relation(fields: [childId], references: [id])
  items           VisitItem[]
}

model VisitItem {
  id        String   @id @default(cuid())
  visitId   String
  productId String
  quantity  Int
  unitPrice Decimal
  total     Decimal
  createdAt DateTime @default(now())
  visit     Visit    @relation(fields: [visitId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
}

model PartyPackage {
  id               String    @id @default(cuid())
  name             String
  maxGuests        Int
  weekdayPrice     Decimal
  weekendPrice     Decimal
  description      String?
  active           Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  parties          Party[]
}

model Party {
  id                String      @id @default(cuid())
  birthdayChildName String
  tutorName         String
  tutorCpf          String
  tutorEmail        String
  tutorPhone        String
  tutorAddress      String
  date              DateTime
  timeSlot          String
  packageId         String
  holidayCustom     Boolean     @default(false)
  status            String      @default("CONFIRMADA")
  amountTotal       Decimal
  amountPaid        Decimal     @default(0)
  cancelReason      String?
  notes             String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  package           PartyPackage @relation(fields: [packageId], references: [id])
}

model FiscalConfig {
  id              String   @id @default(cuid())
  environment     String
  series          Int
  nextNfeNumber   Int
  nextNfceNumber  Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model DigitalCertificate {
  id              String   @id @default(cuid())
  cnpj            String
  validUntil      DateTime
  status          String
  filePath        String
  importedAt      DateTime @default(now())
  operatorName    String
}

model FiscalInvoice {
  id              String        @id @default(cuid())
  number          Int
  series          Int
  type            String
  customerName    String
  customerDoc     String
  totalValue      Decimal
  status          String         @default("PENDENTE")
  issuedAt        DateTime      @default(now())
  xmlPath         String?
  danfePath       String?
  operatorName    String
  cancelations    FiscalCancellation[]
}

model FiscalCancellation {
  id              String       @id @default(cuid())
  invoiceId       String
  justification   String
  canceledAt      DateTime     @default(now())
  operatorName    String
  invoice         FiscalInvoice @relation(fields: [invoiceId], references: [id])
}

model Notification {
  id              String   @id @default(cuid())
  tutorPhone      String
  channel         String
  status          String
  message         String
  scheduledAt     DateTime
  sentAt          DateTime?
  createdAt       DateTime @default(now())
}

model AuditLog {
  id              String   @id @default(cuid())
  userId          String
  action          String
  targetType      String
  targetId        String
  details         String?
  ipAddress       String?
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])
}
